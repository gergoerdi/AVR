#include <Arduino.h>
#include "Motion.h"

static uint16_t times[] =
	{ 20000, 12330, 9514, 7984, 6998, 6298, 5769, 5352, 5013, 4730
/*
	, 4490, 4282, 4100, 3940, 3797, 3668, 3551, 3445, 3347, 3258
	, 3175, 3098, 3026, 2960, 2897, 2838, 2783, 2730, 2681, 2634
	, 2589, 2547, 2507, 2468, 2431, 2396, 2362, 2330, 2299, 2269
	, 2240, 2213, 2186, 2160, 2135, 2111, 2088, 2066, 2044, 2023
	, 2002, 1983, 1963, 1945, 1926, 1909, 1891, 1875, 1858, 1842
	, 1827, 1812, 1797, 1783, 1769, 1755, 1741, 1728, 1715, 1703
	, 1691, 1679, 1667, 1655, 1644, 1633, 1622, 1611, 1601, 1591
	, 1581, 1571, 1561, 1552, 1543, 1533, 1524, 1516, 1507, 1498
	, 1490, 1482, 1474, 1466, 1458, 1450, 1442, 1435, 1428, 1420
	, 1413, 1406, 1399, 1392, 1386, 1379, 1372, 1366, 1360, 1353
	, 1347, 1341, 1335, 1329, 1323, 1317, 1312, 1306, 1300, 1295
	, 1289, 1284, 1279, 1274, 1268, 1263, 1258, 1253, 1248, 1243
	, 1239, 1234, 1229, 1225, 1220, 1215, 1211, 1206, 1202, 1198
	, 1193, 1189, 1185, 1181, 1177, 1173, 1169, 1165, 1161, 1157
	, 1153, 1149, 1145, 1141, 1138, 1134, 1130, 1127, 1123, 1120
	, 1116, 1113, 1109, 1106, 1102, 1099, 1096, 1092, 1089, 1086
	, 1083, 1079, 1076, 1073, 1070, 1067, 1064, 1061, 1058, 1055
	, 1052, 1049, 1046, 1043, 1040, 1038, 1035, 1032, 1029, 1027
	, 1024, 1021, 1018, 1016, 1013, 1011, 1008, 1005, 1003, 1000
*/
	};
 

Motion::Motion(Stepper *m): m_m(m), m_pos(0)
{
	m_m->setPWM(2048);
	m_m->step(Hlt);
}

void Motion::Calibrate()
{
}

void Motion::MoveTo(int16_t pos)
{
	Direction dir = pos < m_pos ? Rev : Fwd;
	int16_t n = pos > m_pos ? (pos - m_pos) : (m_pos - pos); // abs(pos - m_pos);
	int16_t nc = min((n - 1) / 2, sizeof(times) / sizeof(*times));
	int16_t t = times[0];

	for (int16_t i = 0; i < n; ++i)
	{
/*
		if (i < nc)
			t = times[i];
		else if (i + nc > n)
			t = times[n - i - 1];

		delayMicroseconds(t);
*/
		delay(t / 1000);
		m_m->step(dir);
	}

	m_m->step(Hlt);
}

